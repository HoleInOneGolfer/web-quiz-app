{% extends "base.jinja" %}

{% block content %}
<main id="main" class="no-select box-sizing">
    <div id="quiz-container">
        <div id="info-container">
            <p>
                Question
                <br />
                <span id="question-counter">xx/xx</span>
            </p>
            <p>
                Attempts
                <br />
                <span id="attempt-counter">x/x</span>
            </p>
            <p>
                Score
                <br />
                <span id="score-counter">xxx</span>
            </p>
        </div>

        <h2 id="question-text">Question?</h2>
        <div id="answer-container">
            <button id="answer-1" onclick="answer(1)">Answer 1</button>
            <button id="answer-2" onclick="answer(2)">Answer 2</button>
            <button id="answer-3" onclick="answer(3)">Answer 3</button>
            <button id="answer-4" onclick="answer(4)">Answer 4</button>
        </div>

        <span id="hint-text" class="invisible">Hint text</span>

        <div id="controls-container">
            <button id="restart-button" onclick="restartQuiz()">
                <img src="{{ url_for('static', filename='./images/icon/svg/restart.svg')}}" alt="Exit" />
                Restart
            </button>

            <button id="hint-button" onclick="enableHint()">
                <img src="{{ url_for('static', filename='./images/icon/svg/hint.svg')}}" alt="Hint" />
                Hint
            </button>

            <button id="next-button" onclick="nextQuestion()">
                <img src="{{ url_for('static', filename='./images/icon/svg/next.svg')}}" alt="Next" />
                Next
            </button>
        </div>
    </div>
</main>
{% endblock %}

{% block footer %}{% endblock %}

{% block scripts %}
<script>
    let QUIZ_NAME = "{{ quiz_name }}";
    let QUIZ_DATA = {{ quiz_data | tojson }};
    let STATIC_URL = "{{ url_for('static', filename='') }}";
    let DATA_URL = "{{ url_for('quiz.data', filename='') }}";

    const ELEMENTS = {
        body: document.body,
        headerIcon: document.getElementById('header-icon'),
        questionCounter: document.getElementById('question-counter'),
        attemptCounter: document.getElementById('attempt-counter'),
        scoreCounter: document.getElementById('score-counter'),
        questionText: document.getElementById('question-text'),
        answer1: document.getElementById('answer-1'),
        answer2: document.getElementById('answer-2'),
        answer3: document.getElementById('answer-3'),
        answer4: document.getElementById('answer-4'),
        hintText: document.getElementById('hint-text'),
        nextButton: document.getElementById('next-button'),
    }

    let CURRENT_QUESTION = 1;
    let TOTAL_QUESTIONS = QUIZ_DATA.length;

    let ATTEMPTS = 0;
    let TOTAL_ATTEMPTS = 0;
    let ATTEMPTED_ANSWERS = [];

    let HINT_USED = false;

    let CORRECT = false;
    let SCORE = 0;

    let QUESTION_RESULTS = []

    // === RESET Functions === //

    function reset() {
        CORRECT = false;
        HINT_USED = false;
        ATTEMPTED_ANSWERS = [];
        ATTEMPTS = 0;

        disableHint();
        updateIcon();
        updateBackground();
        setNextMode(!CORRECT);
        updateAnswers();
        updateInfoText();
        updateQuestionText();
    }

    // === UPDATE Functions === //

    function updateIcon() {
        QUESTION_ICON = QUIZ_DATA[CURRENT_QUESTION - 1].logo_image;
        if (QUESTION_ICON) {
            ELEMENTS.headerIcon.src = DATA_URL + QUESTION_ICON
            ELEMENTS.headerIcon.alt = QUIZ_NAME;
        }
        else {
            ELEMENTS.headerIcon.src = STATIC_URL + "images/icon.png";
            ELEMENTS.headerIcon.alt = "Quiz Icon";
        }
    }

    function updateBackground() {
        QUESTION_BACKGROUND = QUIZ_DATA[CURRENT_QUESTION - 1].bg_image;
        if (QUESTION_BACKGROUND) {
            ELEMENTS.body.style.backgroundImage = `url('${DATA_URL}${QUESTION_BACKGROUND}')`;
        }
        else {
            ELEMENTS.body.style.backgroundImage = "none";
        }
    }

    function updateInfoText() {
        ELEMENTS.questionCounter.textContent = `${CURRENT_QUESTION}/${TOTAL_QUESTIONS}`;
        ELEMENTS.attemptCounter.textContent = `${ATTEMPTS}/${TOTAL_ATTEMPTS}`;
        ELEMENTS.scoreCounter.textContent = `${Math.round(SCORE / TOTAL_QUESTIONS * 100)}%`;
    }

    function updateQuestionText() {
        ELEMENTS.questionText.textContent = QUIZ_DATA[CURRENT_QUESTION - 1].question_text;
        ELEMENTS.hintText.textContent = QUIZ_DATA[CURRENT_QUESTION - 1].hint;

        ELEMENTS.answer1.textContent = QUIZ_DATA[CURRENT_QUESTION - 1].answer_1;
        ELEMENTS.answer2.textContent = QUIZ_DATA[CURRENT_QUESTION - 1].answer_2;
        ELEMENTS.answer3.textContent = QUIZ_DATA[CURRENT_QUESTION - 1].answer_3;
        ELEMENTS.answer4.textContent = QUIZ_DATA[CURRENT_QUESTION - 1].answer_4;
    }

    function updateAnswer(answerNumber) {
        ELEMENTS[`answer${answerNumber}`].disabled = false;
        ELEMENTS[`answer${answerNumber}`].classList.remove("correct", "incorrect", "hidden");

        if (!QUIZ_DATA[CURRENT_QUESTION - 1][`answer_${answerNumber}`]) {
            ELEMENTS[`answer${answerNumber}`].classList.add("hidden");
        }
    }

    function updateAnswers() {
        answers = validAnswers(CURRENT_QUESTION);
        correct_answers_len = correctAnswers(CURRENT_QUESTION).length;

        TOTAL_ATTEMPTS = Math.max(1, answers.length - correct_answers_len)

        updateAnswer(1);
        updateAnswer(2);
        updateAnswer(3);
        updateAnswer(4);
    }

    // === QUIZ LOGIC Functions === //

    function correctAnswers(question_number) {
        correct_answers = []
        if (QUIZ_DATA[question_number - 1].answer_1_correct)
            correct_answers.push(1);
        if (QUIZ_DATA[question_number - 1].answer_2_correct)
            correct_answers.push(2);
        if (QUIZ_DATA[question_number - 1].answer_3_correct)
            correct_answers.push(3);
        if (QUIZ_DATA[question_number - 1].answer_4_correct)
            correct_answers.push(4);

        return correct_answers;
    }

    function validAnswers(question_number) {
        valid_answers = []
        if (QUIZ_DATA[question_number - 1].answer_1)
            valid_answers.push(1);
        if (QUIZ_DATA[question_number - 1].answer_2)
            valid_answers.push(2);
        if (QUIZ_DATA[question_number - 1].answer_3)
            valid_answers.push(3);
        if (QUIZ_DATA[question_number - 1].answer_4)
            valid_answers.push(4);

        return valid_answers;
    }

    function checkAnswer(answer_number, question_number) {
        correct_answers = correctAnswers(question_number);

        return correct_answers.includes(answer_number);
    }

    function getResults() {
        results = {
            date: new Date().toISOString(),
            quiz_name: QUIZ_NAME,
            total_score: SCORE,
            total_questions: TOTAL_QUESTIONS,
        }

        for (let i = 0; i < QUESTION_RESULTS.length; i++) {
            for (const [key, value] of Object.entries(QUESTION_RESULTS[i])) {
                results[key] = value;
            }
        }

        return results;
    }

    function submitResults() {
        session_results = getResults();

        fetch('{{ url_for('quiz.submit') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(session_results)
        }).catch((error) => {
            console.error('Error submitting session:', error);
        });

    }

    function revealAnswers() {
        correct_answers = correctAnswers(CURRENT_QUESTION);
        for (let i = 0; i < correct_answers.length; i++) {
            ELEMENTS[`answer${correct_answers[i]}`].classList.toggle("correct", true);
        }
    }

    // === BUTTON Functions === //

    function nextQuestion() {
        results = {}
        results[`question_${CURRENT_QUESTION}_correct`] = CORRECT;
        results[`question_${CURRENT_QUESTION}_hint_used`] = HINT_USED
        results[`question_${CURRENT_QUESTION}_attempts`] = ATTEMPTS;
        results[`question_${CURRENT_QUESTION}_attempted_answers`] = ATTEMPTED_ANSWERS.join(", ");

        QUESTION_RESULTS.push(results);

        if (CURRENT_QUESTION >= TOTAL_QUESTIONS) {
            CURRENT_QUESTION = CURRENT_QUESTION % (TOTAL_QUESTIONS + 1);
            submitResults();

            alert(`Quiz completed! Your score: ${Math.round(SCORE / TOTAL_QUESTIONS * 100)}% \n Your score has been submited. Restarting quiz...`);

            restartQuiz();
        }
        else if (CURRENT_QUESTION < TOTAL_QUESTIONS + 1) {
            CURRENT_QUESTION++;

            reset();
        }
    }

    function restartQuiz() {
        QUESTION_RESULTS = [];
        CURRENT_QUESTION = 1;
        SCORE = 0;

        reset();
    }

    function enableHint() {
        ELEMENTS.hintText.classList.add("visible");
        HINT_USED = true;
    }

    function disableHint() {
        ELEMENTS.hintText.classList.remove("visible");
    }

    function setNextMode(mode = !ELEMENTS.nextButton.disabled) {
        ELEMENTS.nextButton.disabled = mode;
    }

    function answer(answerNumber) {
        if (ATTEMPTS < TOTAL_ATTEMPTS) {
            if (!CORRECT) {
                if (!ATTEMPTED_ANSWERS.includes(answerNumber)) {
                    ATTEMPTED_ANSWERS.push(answerNumber);
                    ATTEMPTS++;
                    ELEMENTS[`answer${answerNumber}`].disabled = true;
                }
                CORRECT = checkAnswer(answerNumber, CURRENT_QUESTION);
                if (CORRECT) {
                    SCORE++;
                    setNextMode(!CORRECT);
                    ELEMENTS[`answer${answerNumber}`].classList.add("correct");
                }
                else {
                    ELEMENTS[`answer${answerNumber}`].classList.add("incorrect");
                }
            }
        }
        if (ATTEMPTS > TOTAL_ATTEMPTS - 1) {
            setNextMode(false);

            revealAnswers();
        }

        updateInfoText();
    }

    // === START QUIZ === //
    restartQuiz();
</script>
{% endblock %}
